<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="style.css">
        <title>おーぷんタイムシフト(仮) β1.3</title>
    </head>
    <body>
        <h4 id=snum>ここに現在時刻が表示されます</h4>
        <h1>おーぷんタイムシフト(仮) β1.3</h1>
        <form name="test">
            <input type="button" value="送信" id="button"><br>
            <input type="button" value="1x" onclick="speed=1000"><br>
            <input type="button" value="2x" onclick="speed=500"><br>
            <textarea id="a" name="txt" rows="10" cols="40"></textarea>
        </form>
        <div id="msb"></div>
        <div class=message>
            <div class=names>
                <p class=rnum>10: </p>
                <p class=name>名無しさん＠おーぷん </p>
                <p class=date>20/10/11 10:34:32 </p>
            </div>
            <div class=msg>
                <p>This is a message.</p>

            </div>
        </div>
    </body>

</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
let message
let msg = []
let time
let speed = 1000;
let sec = -1
let resn = 0
$(function(){

    $.ajaxSetup({
        beforeSend: function(xhr){
            xhr.overrideMimeType("text/html;charset=Shift_JIS");
        }
    });
    $("#button").click(function() {
		
		const str1 = $('#a').val();
        let str2 = str1.slice(0,65).replace('test/read.cgi/livejupiter','livejupiter/dat')
        str2 += '.dat'
        $.get(str2, function(data){    
            let be = data.split('\n')
            for(i=0;i<be.length-1;i++){
                message = be[i].split('<>')
                clock = message[2].slice(-15,-7).split(":")
                time=message[2].slice(-9,-7) 
                msg.push({date:message[2],name:message[0],num:clock,sec:time,msg:message[3]})                
            }
            hour = Number(msg[0].num[0])
            min = Number(msg[0].num[1])
            sec = Number(msg[0].num[2])-1
        });
        read()
	});

})
function read(){
    window.setTimeout(read,speed)
    sec++
    if(msg[resn].sec == ('00'+sec).slice(-2)){
        resn++
        write()
        
    }
    if(sec==60){
        sec=0
        min++
        if(min==60){
            min=0
            hour++
            if(hour==25){
                hour=0
            }
        }
    }
    
    document.getElementById('snum').innerText = ("00"+(hour).toString()).slice(-2)+":"+(min.toString()).slice(-2)+":"+("00"+(sec).toString()).slice(-2);
}

function write(){
    const ms = document.querySelector('.message').outerHTML
    document.getElementById('msb').insertAdjacentHTML('afterbegin',ms)
    document.querySelector('.rnum').innerText=resn
    document.querySelector('.date').innerText=msg[resn-1].date
    document.querySelector('.name').innerText=msg[resn-1].name
    document.querySelector('.msg').innerHTML='<p>'+msg[resn-1].msg+'</p>'
    if(msg[resn].sec == ('00'+sec).slice(-2)){
        resn++
        console.log(resn)
        console.log('aa')
        write();
    }else{
        console.log(msg[resn].num);
        console.log(msg[resn-1].num)
    }
}

document.getElementById('button').onclick = function(){
    console.log()
} 
 /* #read_text のテキストを data に変更 */
 
 
</script>